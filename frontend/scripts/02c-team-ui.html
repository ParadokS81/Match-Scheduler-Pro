<script>
    /*
     * Schedule Manager - Team & UI Management
     *
     * @version 1.1.0 (2025-06-08) - Added renderBrowseAllTeams function for right panel
     * @version 1.0.0 (2025-06-07) - Extracted from 02-core.html for better organization.
     *
     * Purpose: Team switching, UI management, and form handling
     * Dependencies: Global variables from 01-init.html (userContext, appConfig, currentActiveTeamId)
     * Provides: Team management, view switching, form submission handlers
     * Functions: setActiveTeam, populateTeamCardsAndActiveTeam, showMainApp, handleJoinTeamSubmit, renderBrowseAllTeams
     */
    function showMainApp() {
        document.getElementById('initial-view-container').classList.add('hidden');
        document.getElementById('main-app-layout').classList.remove('hidden');
        document.getElementById('main-app-layout').classList.add('flex');
    }

    function showInitialView(htmlContent) {
        document.getElementById('main-app-layout').classList.add('hidden');
        document.getElementById('main-app-layout').classList.remove('flex');
        const container = document.getElementById('initial-view-container');
        container.innerHTML = htmlContent;
        container.classList.remove('hidden');
        container.classList.add('flex');
    }
    
    function displayFormMessage(message, isSuccess, formType) {
        const messageDivId = formType === 'join' ? 'join-form-message' : 'create-form-message';
        const messageDiv = document.getElementById(messageDivId);
        if (messageDiv) {
            messageDiv.textContent = message;
            messageDiv.className = `mt-2 text-xs ${isSuccess ? 'text-green-400' : 'text-red-400'}`;
        }
    }

    function populateUserPanel(context) {
        document.getElementById('left-panel-user-display-name').textContent = context.displayName || 'User';
        document.getElementById('left-panel-user-role').textContent = context.role ? formatRole(context.role) : 'Guest';
    }
    
    function populateTeamCardsAndActiveTeam(teamsContext) {
        const teamCardsHeaderContainer = document.getElementById('left-panel-team-cards-header-container');
        teamCardsHeaderContainer.innerHTML = ''; 

        if (teamsContext && teamsContext.length > 0) {
            const teamCardsFlexContainer = document.createElement('div');
            teamCardsFlexContainer.className = 'flex space-x-1';
            
            teamsContext.forEach((team, index) => {
                const button = document.createElement('button');
                button.className = `left-panel-team-card ${index === 0 ? 'active' : 'inactive'}`;
                button.textContent = team.teamName; 
                button.dataset.teamId = team.teamId;
                
                button.addEventListener('click', () => {
                    currentActiveTeamId = team.teamId;
                    setActiveTeam(team.teamId, team.teamName, team.logoUrl || appConfig.defaultLogoUrl, team.roster || [], team.role); 
                    
                    teamCardsHeaderContainer.querySelectorAll('.left-panel-team-card').forEach(btn => {
                        btn.classList.remove('active');
                        btn.classList.add('inactive');
                    });
                    button.classList.add('active');
                    button.classList.remove('inactive');
                });
                teamCardsFlexContainer.appendChild(button);
            });
            teamCardsHeaderContainer.appendChild(teamCardsFlexContainer);
            
            const firstTeam = teamsContext[0];
            if (firstTeam) {
                currentActiveTeamId = firstTeam.teamId;
                setActiveTeam(firstTeam.teamId, firstTeam.teamName, firstTeam.logoUrl || appConfig.defaultLogoUrl, firstTeam.roster || [], firstTeam.role);
            }
        } else {
            teamCardsHeaderContainer.innerHTML = '<p class="text-xs text-slate-400 italic">No teams joined yet.</p>';
            clearActiveTeamDisplay();
            if(userContext) document.getElementById('left-panel-user-role').textContent = userContext.role ? formatRole(userContext.role) : 'Guest';
        }
    }

    /**
     * Renders the Browse All Teams list in the right sidebar
     * @param {Array} teams - Array of lightweight team objects from getLightweightTeamList()
     * @param {Array} favorites - Array of favorite team IDs from userContext.favorites
     */
    function renderBrowseAllTeams(teams, favorites) {
        console.log('Rendering Browse All Teams:', { teamsCount: teams.length, favoritesCount: favorites.length });
        
        const container = document.getElementById('browse-all-teams-list');
        if (!container) {
            console.error('Browse all teams container not found');
            return;
        }
        
        // Clear existing content
        container.innerHTML = '';
        
        if (!teams || teams.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.196-2.121M9 12a4 4 0 008 0m-8 0a4 4 0 118 0m-8 0v8a2 2 0 002 2h4a2 2 0 002-2v-8"></path>
                    </svg>
                    <p class="text-slate-400">No teams available</p>
                </div>
            `;
            return;
        }
        
        // Group teams by division
        const teamsByDivision = {};
        teams.forEach(team => {
            const division = team.division || 'Unknown';
            if (!teamsByDivision[division]) {
                teamsByDivision[division] = [];
            }
            teamsByDivision[division].push(team);
        });
        
        // Sort divisions
        const sortedDivisions = Object.keys(teamsByDivision).sort((a, b) => {
            if (a === 'Unknown') return 1;
            if (b === 'Unknown') return -1;
            return parseInt(a) - parseInt(b);
        });
        
        // Render each division group
        sortedDivisions.forEach(division => {
            // Division header
            const divisionHeader = document.createElement('div');
            divisionHeader.className = 'text-xs font-semibold text-slate-400 uppercase tracking-wide px-2 py-2 border-b border-slate-600/30 bg-slate-700/20';
            divisionHeader.textContent = division === 'Unknown' ? 'Other Teams' : `Division ${division}`;
            container.appendChild(divisionHeader);
            
            // Teams in this division
            teamsByDivision[division].forEach(team => {
                const isFavorite = favorites.includes(team.teamId);
                
                const teamCard = document.createElement('div');
                teamCard.className = 'team-card bg-slate-700/20 hover:bg-slate-700/40 p-3 transition-colors cursor-pointer border-b border-slate-600/20 last:border-b-0';
                teamCard.dataset.teamId = team.teamId;
                
                teamCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                            <div class="flex-shrink-0">
                                <img src="${team.logoUrl || appConfig.defaultLogoUrl}" 
                                     alt="${team.teamName} logo" 
                                     class="w-8 h-8 rounded object-cover bg-slate-600">
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="team-name text-sm font-medium text-slate-200 truncate">${team.teamName}</h4>
                                <div class="text-xs text-slate-400">
                                    <span>Leader: ${team.leaderName || 'Loading...'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 flex-shrink-0">
                            <button class="favorite-star-btn p-1 hover:bg-slate-600/50 rounded transition-colors"
                                    data-team-id="${team.teamId}" 
                                    data-is-favorite="${isFavorite}">
                                <svg class="w-4 h-4 lucide-star ${isFavorite ? 'text-amber-400' : 'text-slate-500'}" 
                                     fill="${isFavorite ? 'currentColor' : 'none'}" 
                                     stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="m12 2 3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2Z"/>
                                </svg>
                            </button>
                            <button class="team-info-btn p-1 hover:bg-slate-600/50 rounded transition-colors"
                                    data-team-id="${team.teamId}">
                                <svg class="w-4 h-4 text-slate-400 hover:text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(teamCard);
            });
        });
        
        console.log('Browse All Teams rendered successfully');
    }

    function formatRole(role) {
        if (!role) return "";
        return role.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }

    function setActiveTeam(teamId, teamName, logoUrl, roster, roleInTeam) {
        console.log("[ClientScript] Setting active team:", teamId, teamName, "Role in this team:", roleInTeam);
        
        // Clear cache if switching to different team
        if (currentActiveTeamId !== teamId) {
            clearWeekCache();
            showingFutureWeeks = false; // Reset to current view
            updateNavigationButtons();
        }
        
        document.getElementById('left-panel-team-logo-area').querySelector('img').src = logoUrl || appConfig.defaultLogoUrl;
        const rosterArea = document.getElementById('left-panel-team-roster-area');
        rosterArea.innerHTML = ''; 
        
        const displayRoster = (roster && roster.length > 0) ? roster : [{displayName: "No roster data for " + teamName, initials: "--"}];
        displayRoster.forEach(player => {
            const playerDiv = document.createElement('div');
            playerDiv.className = 'flex justify-between items-center py-0.5';
            playerDiv.innerHTML = `
                <span class="text-slate-200">${player.displayName}</span>
                <span class="text-sky-400 font-mono">${player.initials || '--'}</span>`;
            rosterArea.appendChild(playerDiv);
        });

        const globalRoleFormatted = formatRole(userContext.role);
        const roleInThisTeamFormatted = formatRole(roleInTeam);
        
        let combinedRoleDisplay = globalRoleFormatted;
        if (roleInThisTeamFormatted && teamName) { // Ensure teamName is available
            if (globalRoleFormatted.toLowerCase() !== roleInThisTeamFormatted.toLowerCase()) {
                combinedRoleDisplay = `${globalRoleFormatted} - ${roleInThisTeamFormatted} of ${teamName}`;
            } else { 
                 combinedRoleDisplay = `${roleInThisTeamFormatted} of ${teamName}`;
            }
        } else if (globalRoleFormatted && teamName) {
            combinedRoleDisplay = `${globalRoleFormatted} (Viewing ${teamName})`;
        } else if (globalRoleFormatted) {
             combinedRoleDisplay = globalRoleFormatted;
        } else {
            combinedRoleDisplay = "Role Undefined";
        }
        document.getElementById('left-panel-user-role').textContent = combinedRoleDisplay;
        
        const teamManagementSection = document.getElementById('left-panel-team-management-section');
        if (roleInTeam === appConfig.roles.TEAM_LEADER || userContext.role === appConfig.roles.ADMIN) {
            teamManagementSection.style.display = 'block';
        } else {
            teamManagementSection.style.display = 'none';
        }
        loadTeamSchedule(teamId); 
    }
    
    function clearActiveTeamDisplay() {
        document.getElementById('left-panel-team-logo-area').querySelector('img').src = appConfig.defaultLogoUrl; 
        document.getElementById('left-panel-team-roster-area').innerHTML = '<p class="text-xs text-slate-400 italic">No active team selected.</p>';
    }

function handleJoinTeamSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const joinCode = form.joinCode.value;
    const initials = form.joinInitials.value;
    // The 'displayName' variable is no longer needed here.
    displayFormMessage("Attempting to join team...", true, 'join');
    google.script.run
        .withSuccessHandler(function(response){
            displayFormMessage(response.message, response.success, 'join');
            if (response.success) { setTimeout(() => window.location.reload(), 1500); }
        })
        .withFailureHandler(function(error){
            displayFormMessage(`Error: ${error.message || 'Failed to join team.'}`, false, 'join');
        })
        // Updated call with the new, simpler signature.
        .joinTeamWithCode(joinCode, initials);
}

function handleProfileUpdateSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const saveButton = document.getElementById('save-profile-btn');
    const originalButtonText = saveButton.innerHTML;
    saveButton.innerHTML = 'Saving...';
    saveButton.disabled = true;

    const profileData = {
        displayName: form.displayName.value,
        discordUsername: form.discordUsername.value
    };

    google.script.run
        .withSuccessHandler(function(response) {
            const messageDiv = document.getElementById('profile-form-message');
            if (response.success) {
                messageDiv.className = 'mt-4 text-xs text-green-400';
                messageDiv.textContent = 'Profile updated successfully!';
                
                // Update local context and UI immediately
                if (userContext && response.player) {
                    userContext.displayName = response.player.displayName;
                    userContext.discordUsername = response.player.discordUsername;
                    populateUserPanel(userContext);
                }

                setTimeout(() => {
                    document.getElementById('profile-editor-modal').classList.add('hidden');
                    messageDiv.textContent = ''; // Clear message on close
                }, 1000);

            } else {
                messageDiv.className = 'mt-4 text-xs text-red-400';
                messageDiv.textContent = `Error: ${response.message}`;
            }
            saveButton.innerHTML = originalButtonText;
            saveButton.disabled = false;
        })
        .withFailureHandler(function(error) {
            const messageDiv = document.getElementById('profile-form-message');
            messageDiv.className = 'mt-4 text-xs text-red-400';
            messageDiv.textContent = `Error: ${error.message}`;
            saveButton.innerHTML = originalButtonText;
            saveButton.disabled = false;
        })
        .updateMyProfile(profileData);
}

    function handleCreateTeamSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const teamData = { teamName: form.teamName.value, division: form.division.value };
        const creatorInitials = form.creatorInitials.value;
        const creatorDisplayName = form.creatorDisplayName.value;
        displayFormMessage("Attempting to create team...", true, 'create');
        google.script.run
            .withSuccessHandler(function(response){
                displayFormMessage(response.message, response.success, 'create');
                if (response.success) { setTimeout(() => window.location.reload(), 1500); }
            })
            .withFailureHandler(function(error){
                 displayFormMessage(`Error: ${error.message || 'Failed to create team.'}`, false, 'create');
            })
            .createNewTeam(teamData, creatorInitials, creatorDisplayName); // Matches WebAppController
    }

    function handleInitialView() {
        console.log("[ClientScript] handleInitialView called.");
        if (!userContext || !userContext.isAuthenticated) {
            showInitialView(`
                <div class="bg-slate-800 p-8 rounded-lg shadow-xl text-center max-w-md">
                    <h2 class="text-2xl font-bold text-sky-400 mb-4">Welcome to Schedule Manager!</h2>
                    <p class="text-slate-300 mb-6">Please log in with your Google account to manage your team schedules and availability.</p>
                    <p class="text-xs text-slate-500">(Login is typically handled automatically by Google when accessing the web app.)</p>
                </div>
            `);
        } else if (!userContext.teams || userContext.teams.length === 0) {
            const divisionSelectEl = document.createElement('select');
            divisionSelectEl.id = "create-division";
            divisionSelectEl.name = "division";
            divisionSelectEl.className = "form-select";
            divisionSelectEl.required = true;
            if(appConfig.allowedDivisions && appConfig.allowedDivisions.length > 0){
                appConfig.allowedDivisions.forEach(div => {
                    const option = document.createElement('option'); option.value = div; option.textContent = `Division ${div}`;
                    divisionSelectEl.appendChild(option);
                });
            } else {
                 const option = document.createElement('option'); option.value = "0"; option.textContent = "No divisions configured";
                 divisionSelectEl.appendChild(option);
            }
            showInitialView(`
                <div class="bg-slate-800 p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-lg">
                    <h2 class="text-2xl font-bold text-sky-400 mb-2">Welcome, ${userContext.displayName}!</h2>
                    <p class="text-slate-400 mb-6">You're not on any teams yet. Get started below:</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-semibold text-slate-100 mb-3">Join a Team</h3>
                            <form id="join-team-form" class="space-y-3">
                                <div><label for="join-code" class="block text-sm font-medium text-slate-300 mb-1">Team Join Code</label><input type="text" id="join-code" name="joinCode" class="form-input" required></div>
                                <div><label for="join-initials" class="block text-sm font-medium text-slate-300 mb-1">Your Initials for Team</label><input type="text" id="join-initials" name="joinInitials" class="form-input" maxlength="3" required placeholder="e.g., JD"></div>
                                <button type="submit" class="form-button w-full">Join Team</button>
                                <div id="join-form-message" class="mt-2 text-xs"></div>
                            </form>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-slate-100 mb-3">Create a New Team</h3>
                            <form id="create-team-form" class="space-y-3">
                                <div><label for="create-team-name" class="block text-sm font-medium text-slate-300 mb-1">New Team Name</label><input type="text" id="create-team-name" name="teamName" class="form-input" required></div>
                                <div id="division-select-container"><label for="create-division" class="block text-sm font-medium text-slate-300 mb-1">Division</label></div>
                                <div><label for="create-initials" class="block text-sm font-medium text-slate-300 mb-1">Your Initials for Team</label><input type="text" id="create-initials" name="creatorInitials" class="form-input" maxlength="3" required placeholder="e.g., JD"></div>
                                <div><label for="create-display-name" class="block text-sm font-medium text-slate-300 mb-1">Your Name for Team</label><input type="text" id="create-display-name" name="creatorDisplayName" class="form-input" required value="${userContext.displayName || ''}"></div>
                                <button type="submit" class="form-button w-full">Create Team</button>
                                <div id="create-form-message" class="mt-2 text-xs"></div>
                            </form>
                        </div>
                    </div>
                </div>
            `);
            const divisionContainer = document.getElementById('division-select-container');
            if (divisionContainer) divisionContainer.appendChild(divisionSelectEl);
            const joinForm = document.getElementById('join-team-form');
            if(joinForm) joinForm.addEventListener('submit', handleJoinTeamSubmit);
            const createForm = document.getElementById('create-team-form');
            if(createForm) createForm.addEventListener('submit', handleCreateTeamSubmit);
        } else { 
            showMainApp();
            populateUserPanel(userContext); 
            populateTeamCardsAndActiveTeam(userContext.teams);
            
            // Initialize Browse All Teams
            initializeBrowseAllTeams();
        }
    }

    /**
     * Initialize the Browse All Teams functionality
     */
    function initializeBrowseAllTeams() {
        console.log('Initializing Browse All Teams...');
        
        google.script.run
            .withSuccessHandler(function(response) {
                if (response && response.success && response.teams) {
                    const teams = response.teams || [];
                    const favorites = userContext.favorites || [];
                    
                    renderBrowseAllTeams(teams, favorites);
                    
                    // Store timestamp for smart refresh
                    window.teamsListTimestamp = response.timestamp;
                } else {
                    console.error('Failed to load teams list:', response);
                    const container = document.getElementById('browse-all-teams-list');
                    if (container) {
                        container.innerHTML = '<div class="text-center py-4 text-red-400">Failed to load teams</div>';
                    }
                }
            })
            .withFailureHandler(function(error) {
                console.error('Error loading teams list:', error);
                const container = document.getElementById('browse-all-teams-list');
                if (container) {
                    container.innerHTML = '<div class="text-center py-4 text-red-400">Error loading teams</div>';
                }
            })
            .getLightweightTeamList();
    }
// --- Profile Editor Modal Events (V2 - Image is always visible) ---
    const profileModal = document.getElementById('profile-editor-modal');
    const editProfileLink = document.getElementById('edit-profile-link');
    const profileForm = document.getElementById('profile-editor-form');
    const cancelProfileBtn = document.getElementById('cancel-profile-btn');

    if (editProfileLink) {
        editProfileLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (profileModal && userContext) {
                // Populate form with current user data
                profileForm.displayName.value = userContext.displayName || '';
                profileForm.discordUsername.value = userContext.discordUsername || '';
                document.getElementById('profile-form-message').textContent = '';
                
                // Set the help image source from configuration when the modal opens
                const helpImage = document.getElementById('discord-info-image');
                if (helpImage && window.BLOCK_CONFIG_CLIENT && window.BLOCK_CONFIG_CLIENT.WEB_APP.DISCORD_HELP_IMAGE_URL) {
                    helpImage.src = window.BLOCK_CONFIG_CLIENT.WEB_APP.DISCORD_HELP_IMAGE_URL;
                }

                profileModal.classList.remove('hidden');
            }
        });
    }

    if (cancelProfileBtn) {
        cancelProfileBtn.addEventListener('click', () => {
            if (profileModal) profileModal.classList.add('hidden');
        });
    }

    if (profileForm) {
        profileForm.addEventListener('submit', handleProfileUpdateSubmit);
    }

  </script>